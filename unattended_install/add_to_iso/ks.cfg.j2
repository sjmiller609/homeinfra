#Generated by Kickstart Configurator
#platform=AMD64 or Intel EM64T

#System language
lang en_US
#Language modules to install
langsupport en_US
#System keyboard
keyboard us
#System mouse
mouse

#System timezone
timezone America/New_York

#Root password
rootpw --disabled

#Initial user
#TODO: --is-crypted
user {{ username }} --fullname "{{ full_name }}" --password {{ password }}

#Reboot after installation
reboot

#Use text mode install
text

#Install OS instead of upgrade
install

#Use CDROM installation media
cdrom

#System bootloader configuration
bootloader --location=mbr 

#Clear the Master Boot Record
zerombr yes

#Partition clearing information
clearpart --all --initlabel 

#Disk partitioning information
part swap --size 2048 
part /boot --fstype ext4 --size 512 
part / --fstype ext4 --size 1 --grow 

#System authorization infomation
auth  --useshadow  --enablemd5 

#Network information
network --bootproto=dhcp --device=eth0

#Firewall configuration
firewall --enabled --ssh

#Do not configure the X Window System
skipx

# Add your custom post installation script here
%post --log=/root/ks-post.log

# install stuff
sudo apt-get update
sudo apt-get install -y build-essential libssl-dev libffi-dev python-dev
sudo apt-get install -y openssl python python-pip git

# install minimal desktop before reboot
sudo apt-get install -y --no-install-recommends lubuntu-core

# set auto log for our user
mkdir -p /etc/lightdm/lightdm.conf
echo "
[SeatDefaults]
autlogin-user={{ username }}" > /etc/lightdm/lightdm.conf

# Set locale
echo 'LANG="en_US.UTF-8"' > /etc/default/locale
echo 'LANGUAGE="en_US:en"' >> /etc/default/locale
echo 'LC_ALL="en_US.UTF-8"' >> /etc/default/locale

# install ansible, set playbook in rc.local
pip install ansible
cd /opt
#use IP for github because we cannot resolve in post
git clone https://192.30.253.113/sjmiller609/homeinfra.git
echo "
[all:children]
local
[local]
localhost ansible_connection=local ansible_become_pass={{ password }}
" > /opt/homeinfra/hosts.yml

# run the playbook each time the user logs in
echo "ansible-playbook -i /opt/homeinfra/hosts.yml /opt/homeinfra/{{ playbook_to_run }}" >> /home/{{ username }}/.profile

# Clean
apt-get -f -y install
apt-get -y autoremove
apt-get clean
